<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Whakatu Listening Station</title>
<style>
* {
  -webkit-box-sizing: border-box;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  width: 100%;
  height: 100%;
  background: #0a0a0a;
  overflow: hidden;
}

#art-area {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 15%;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-orient: vertical;
  -webkit-box-direction: normal;
  -ms-flex-direction: column;
  flex-direction: column;
  -webkit-box-align: center;
  -ms-flex-align: center;
  align-items: center;
  -webkit-box-pack: center;
  -ms-flex-pack: center;
  justify-content: center;
  padding: 16px 16px 8px;
}

#header {
  text-align: center;
  margin-bottom: 12px;
  -ms-flex-negative: 0;
  flex-shrink: 0;
}

#station-name {
  font-family: Georgia, serif;
  font-size: 18px;
  color: #c8a96e;
  letter-spacing: 2px;
}

#month-label {
  font-family: Arial, sans-serif;
  font-size: 11px;
  color: #6b6560;
  letter-spacing: 3px;
  text-transform: uppercase;
  margin-top: 3px;
}

#artwork-wrap {
  -webkit-box-flex: 1;
  -ms-flex: 1;
  flex: 1;
  width: 100%;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-align: center;
  -ms-flex-align: center;
  align-items: center;
  -webkit-box-pack: center;
  -ms-flex-pack: center;
  justify-content: center;
  min-height: 0;
}

#artwork {
  display: block;
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  background: #111;
}

#track-title {
  font-family: Arial, sans-serif;
  font-size: 13px;
  color: #f0ece4;
  text-align: center;
  padding: 8px 16px 0;
  -ms-flex-negative: 0;
  flex-shrink: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  width: 100%;
}

#controls-bar {
  position: absolute;
  left: 0;
  right: 0;
  bottom: 0;
  height: 15%;
  background: #111;
  border-top: 1px solid #2a2a2a;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-align: center;
  -ms-flex-align: center;
  align-items: center;
  padding: 0 12px;
}

#logo-wrap {
  -ms-flex-negative: 0;
  flex-shrink: 0;
  margin-right: 12px;
}

#logo {
  height: 44px;
  width: auto;
  display: block;
}

#buttons {
  -webkit-box-flex: 1;
  -ms-flex: 1;
  flex: 1;
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: center;
  -ms-flex-pack: center;
  justify-content: center;
  -webkit-box-align: center;
  -ms-flex-align: center;
  align-items: center;
}

#status-wrap {
  -ms-flex-negative: 0;
  flex-shrink: 0;
  width: 44px;
  text-align: right;
}

#status {
  font-family: Arial, sans-serif;
  font-size: 10px;
  color: #6b6560;
  line-height: 1.3;
}

.ctrl-btn {
  background: #2a2a2a;
  border: 2px solid #666;
  color: #f0ece4;
  border-radius: 10px;
  width: 68px;
  height: 48px;
  font-size: 22px;
  line-height: 44px;
  text-align: center;
  margin: 0 8px;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.ctrl-btn.active {
  background: #3a3a3a;
  border-color: #c8a96e;
}
</style>
</head>
<body>

<div id="art-area">
  <div id="header">
    <div id="station-name">Whakatu Listening Station</div>
    <div id="month-label"></div>
  </div>
  <div id="artwork-wrap">
    <img id="artwork" src="" alt="">
  </div>
  <div id="track-title"></div>
</div>

<div id="controls-bar">
  <div id="logo-wrap">
    <img id="logo" src="logo.png" alt="Whakatu" onerror="this.style.display='none'">
  </div>
  <div id="buttons">
    <div class="ctrl-btn" id="prev-btn">&#9664;&#9664;</div>
    <div class="ctrl-btn" id="stop-btn">&#9646;&#9646;</div>
    <div class="ctrl-btn" id="next-btn">&#9654;&#9654;</div>
  </div>
  <div id="status-wrap">
    <span id="status">Loading</span>
  </div>
</div>

<audio id="player"></audio>

<script>
var months = ['January','February','March','April','May','June',
  'July','August','September','October','November','December'];
document.getElementById('month-label').innerHTML =
  'Hits of ' + months[new Date().getMonth()];

var tracks = [];
var idx = 0;
var stopped = false;
var player = document.getElementById('player');
var artwork = document.getElementById('artwork');
var trackTitle = document.getElementById('track-title');
var status = document.getElementById('status');

function loadTracks() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', 'tracks.json?v=' + new Date().getTime(), true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        try {
          tracks = JSON.parse(xhr.responseText);
        } catch(e) {
          tracks = [];
        }
        if (tracks.length > 0) {
          status.innerHTML = 'Ready';
          showTrack(0);
        } else {
          status.innerHTML = 'No tracks';
        }
      } else {
        status.innerHTML = 'Error ' + xhr.status;
      }
    }
  };
  xhr.send();
}

function showTrack(i) {
  idx = ((i % tracks.length) + tracks.length) % tracks.length;
  var t = tracks[idx];
  trackTitle.innerHTML = t.title;
  if (t.image) {
    artwork.src = t.image;
    artwork.style.display = 'block';
  } else {
    artwork.style.display = 'none';
  }
  player.src = t.audio;
}

function playTrack(i) {
  stopped = false;
  showTrack(i);
  var p = player.play();
  if (p !== undefined) {
    p.then(function() {
      status.innerHTML = '';
    }).catch(function() {
      status.innerHTML = 'Tap play';
    });
  }
}

player.addEventListener('ended', function() {
  if (!stopped) {
    playTrack(idx + 1);
  }
});

function flashBtn(id) {
  var el = document.getElementById(id);
  el.className = 'ctrl-btn active';
  setTimeout(function() { el.className = 'ctrl-btn'; }, 200);
}

document.getElementById('prev-btn').addEventListener('click', function() {
  flashBtn('prev-btn');
  if (player.currentTime > 3) {
    player.currentTime = 0;
    if (!stopped) player.play();
  } else {
    playTrack(idx - 1);
  }
});

document.getElementById('stop-btn').addEventListener('click', function() {
  flashBtn('stop-btn');
  stopped = true;
  player.pause();
  player.currentTime = 0;
  status.innerHTML = 'Stopped';
});

document.getElementById('next-btn').addEventListener('click', function() {
  flashBtn('next-btn');
  playTrack(idx + 1);
});

loadTracks();
</script>
</body>
</html>
