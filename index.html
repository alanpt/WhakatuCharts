<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a0a0a">
<title>Whakatu Listening Station</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="logo.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Barlow+Condensed:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0a0a0a;
    --surface: #111;
    --text: #f0ece4;
    --muted: #6b6560;
    --accent: #c8a96e;
    --love: #d4544a;
    --love-dim: #7a2f2b;
    --radius: 4px;
  }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'Barlow Condensed', sans-serif;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }

  body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-between;
    min-height: 100dvh;
    padding: env(safe-area-inset-top, 16px) 24px env(safe-area-inset-bottom, 24px);
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 100;
    opacity: 0.5;
  }

  header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 10px;
    padding-top: 8px;
    flex-shrink: 0;
  }

  #logo {
    height: clamp(40px, 8vw, 64px);
    width: auto;
    object-fit: contain;
  }

  .station-name {
    font-family: 'Playfair Display', serif;
    font-size: clamp(14px, 3.5vw, 22px);
    letter-spacing: 0.12em;
    color: var(--accent);
    text-align: center;
    line-height: 1.2;
  }

  .month-label {
    font-size: clamp(11px, 2.5vw, 15px);
    letter-spacing: 0.22em;
    color: var(--muted);
    text-transform: uppercase;
    text-align: center;
    font-weight: 300;
  }

  #artwork-wrap {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: 420px;
    padding: 12px 0;
  }

  #artwork {
    width: min(72vw, 72vh, 340px);
    height: min(72vw, 72vh, 340px);
    object-fit: cover;
    border-radius: var(--radius);
    box-shadow: 0 8px 40px rgba(0,0,0,0.7), 0 2px 8px rgba(0,0,0,0.5);
    background: var(--surface);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  #artwork.transitioning {
    opacity: 0;
    transform: scale(0.97);
  }

  #track-title {
    font-size: clamp(15px, 3.5vw, 20px);
    letter-spacing: 0.06em;
    text-align: center;
    color: var(--text);
    font-weight: 400;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 90vw;
    padding: 0 16px;
    flex-shrink: 0;
    min-height: 1.4em;
  }

  .controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: clamp(20px, 6vw, 48px);
    padding: 16px 0 8px;
    flex-shrink: 0;
  }

  .ctrl-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text);
    padding: 12px;
    border-radius: 50%;
    transition: color 0.15s, transform 0.1s, background 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  .ctrl-btn:active {
    transform: scale(0.88);
    background: rgba(255,255,255,0.06);
  }

  .ctrl-btn svg {
    width: clamp(36px, 9vw, 52px);
    height: clamp(36px, 9vw, 52px);
    pointer-events: none;
  }

  #love-btn {
    color: var(--love-dim);
    position: relative;
  }

  #love-btn.loved { color: var(--love); }
  #love-btn.cooling { color: var(--love-dim); }

  #love-btn svg.heart {
    width: clamp(30px, 7.5vw, 44px);
    height: clamp(30px, 7.5vw, 44px);
  }

  #cooldown-ring {
    position: absolute;
    inset: 4px;
    pointer-events: none;
    transform: rotate(-90deg);
    border-radius: 50%;
    display: none;
  }

  #cooldown-ring.visible { display: block; }

  #cooldown-ring circle {
    fill: none;
    stroke: var(--love);
    stroke-width: 2;
    stroke-linecap: round;
  }

  #no-tracks {
    display: none;
    color: var(--muted);
    font-size: 16px;
    letter-spacing: 0.1em;
    text-align: center;
    line-height: 2;
  }

  #loading {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    transition: opacity 0.4s;
  }

  #loading.hidden { opacity: 0; pointer-events: none; }

  .loader-dot {
    width: 8px; height: 8px;
    background: var(--accent);
    border-radius: 50%;
    margin: 0 4px;
    animation: pulse 1.2s ease-in-out infinite;
  }
  .loader-dot:nth-child(2) { animation-delay: 0.2s; }
  .loader-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes pulse {
    0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
    40% { transform: scale(1); opacity: 1; }
  }

  @media (orientation: landscape) and (min-width: 600px) {
    body {
      flex-direction: row;
      flex-wrap: wrap;
      align-content: center;
      gap: 0 48px;
      justify-content: center;
    }
    header { order: 1; flex: 0 0 auto; }
    #artwork-wrap { order: 2; flex: 0 0 auto; padding: 0; }
    #track-title { order: 3; flex: 1 1 100%; }
    .controls { order: 4; flex: 1 1 100%; }
  }
</style>
</head>
<body>

<div id="loading">
  <div class="loader-dot"></div>
  <div class="loader-dot"></div>
  <div class="loader-dot"></div>
</div>

<header>
  <img id="logo" src="logo.png" alt="Whakatu" onerror="this.style.display='none'">
  <div class="station-name">Whakatu Listening Station</div>
  <div class="month-label" id="month-label"></div>
</header>

<div id="artwork-wrap">
  <img id="artwork" src="" alt="">
  <div id="no-tracks">No tracks found.<br>Add .mp3 + image files to /tracks/ and run build-manifest.js</div>
</div>

<div id="track-title"></div>

<div class="controls">
  <button class="ctrl-btn" id="prev-btn" aria-label="Previous track">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"/>
    </svg>
  </button>

  <button class="ctrl-btn" id="love-btn" aria-label="Love this track">
    <svg class="heart" viewBox="0 0 24 24" fill="currentColor">
      <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
    </svg>
    <svg viewBox="0 0 100 100" id="cooldown-ring">
      <circle cx="50" cy="50" r="45"/>
    </svg>
  </button>

  <button class="ctrl-btn" id="next-btn" aria-label="Next track">
    <svg viewBox="0 0 24 24" fill="currentColor">
      <path d="M16 6h2v12h-2zm-2.5 6L6 18V6z"/>
    </svg>
  </button>
</div>

<audio id="player" preload="auto"></audio>

<script>
let tracks = [];
let idx = 0;
const LOVE_COOLDOWN = 10 * 60 * 1000;
let loveLastUsed = 0;
let cooldownTimer = null;
let cooldownRingTimer = null;

const player      = document.getElementById('player');
const artwork     = document.getElementById('artwork');
const trackTitle  = document.getElementById('track-title');
const loveBtn     = document.getElementById('love-btn');
const cooldownRing = document.getElementById('cooldown-ring');
const ringCircle  = cooldownRing.querySelector('circle');
const loading     = document.getElementById('loading');

const months = ['January','February','March','April','May','June',
  'July','August','September','October','November','December'];
document.getElementById('month-label').textContent =
  'Hits of ' + months[new Date().getMonth()];

async function init() {
  try {
    const res = await fetch('tracks.json?v=' + Date.now());
    tracks = await res.json();
  } catch(e) {
    tracks = [];
  }

  loading.classList.add('hidden');

  if (!tracks.length) {
    document.getElementById('no-tracks').style.display = 'block';
    artwork.style.display = 'none';
    return;
  }

  const saved = sessionStorage.getItem('wls-idx');
  idx = saved ? Math.min(parseInt(saved), tracks.length - 1) : 0;
  loadTrack(idx, false);
}

function loadTrack(i, autoplay = true) {
  idx = ((i % tracks.length) + tracks.length) % tracks.length;
  sessionStorage.setItem('wls-idx', idx);
  const t = tracks[idx];

  artwork.classList.add('transitioning');
  setTimeout(() => {
    player.src = t.audio;
    trackTitle.textContent = t.title;
    artwork.src = t.image || '';
    artwork.classList.remove('transitioning');
    if (autoplay) player.play().catch(() => {});
  }, 200);
}

player.addEventListener('ended', () => loadTrack(idx + 1));

document.getElementById('prev-btn').addEventListener('click', () => {
  if (player.currentTime > 3) { player.currentTime = 0; }
  else { loadTrack(idx - 1); }
});

document.getElementById('next-btn').addEventListener('click', () => loadTrack(idx + 1));

loveBtn.addEventListener('click', () => {
  if (Date.now() - loveLastUsed < LOVE_COOLDOWN) return;
  loveLastUsed = Date.now();

  loveBtn.classList.add('loved');
  loveBtn.style.transform = 'scale(1.25)';
  setTimeout(() => { loveBtn.style.transform = ''; }, 200);

  startCooldownRing();

  clearTimeout(cooldownTimer);
  cooldownTimer = setTimeout(() => {
    loveBtn.classList.remove('loved', 'cooling');
    cooldownRing.classList.remove('visible');
  }, LOVE_COOLDOWN);
});

function startCooldownRing() {
  const circumference = 2 * Math.PI * 45;
  ringCircle.style.strokeDasharray = circumference;
  ringCircle.style.strokeDashoffset = 0;
  cooldownRing.classList.add('visible');
  loveBtn.classList.add('cooling');

  const start = Date.now();
  clearInterval(cooldownRingTimer);

  cooldownRingTimer = setInterval(() => {
    const progress = Math.min((Date.now() - start) / LOVE_COOLDOWN, 1);
    ringCircle.style.strokeDashoffset = circumference * (1 - progress);
    if (progress >= 1) {
      clearInterval(cooldownRingTimer);
      cooldownRing.classList.remove('visible');
      loveBtn.classList.remove('cooling');
    }
  }, 1000);
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

init();
</script>
</body>
</html>
