<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Whakatu Listening Station</title>
<style>
body {
  margin: 0;
  padding: 0;
  background: #0a0a0a;
  color: #f0ece4;
  font-family: Georgia, serif;
  text-align: center;
  min-height: 100%;
}

#wrap {
  padding: 20px 16px 32px;
}

#logo {
  max-height: 80px;
  max-width: 80%;
  margin-bottom: 10px;
}

#station-name {
  font-size: 20px;
  color: #c8a96e;
  letter-spacing: 2px;
  margin: 0 0 4px;
}

#month-label {
  font-size: 13px;
  color: #6b6560;
  letter-spacing: 3px;
  text-transform: uppercase;
  margin: 0 0 20px;
}

#artwork {
  width: 280px;
  height: 280px;
  max-width: 80vw;
  max-height: 80vw;
  object-fit: cover;
  background: #222;
  display: block;
  margin: 0 auto 16px;
}

#track-title {
  font-size: 16px;
  color: #f0ece4;
  margin: 0 0 24px;
  padding: 0 16px;
  min-height: 1.4em;
}

#controls {
  display: -webkit-box;
  display: -ms-flexbox;
  display: flex;
  -webkit-box-pack: center;
  -ms-flex-pack: center;
  justify-content: center;
  gap: 40px;
}

.ctrl-btn {
  background: none;
  border: 2px solid #6b6560;
  color: #f0ece4;
  border-radius: 50%;
  width: 64px;
  height: 64px;
  font-size: 28px;
  cursor: pointer;
  line-height: 1;
  -webkit-tap-highlight-color: transparent;
}

.ctrl-btn:active {
  background: #222;
}

#status {
  margin-top: 20px;
  font-size: 13px;
  color: #6b6560;
  min-height: 1.4em;
}
</style>
</head>
<body>
<div id="wrap">
  <img id="logo" src="logo.png" alt="Whakatu" onerror="this.style.display='none'">
  <p id="station-name">Whakatu Listening Station</p>
  <p id="month-label" id="month-label"></p>
  <img id="artwork" src="" alt="">
  <p id="track-title"></p>
  <div id="controls">
    <button class="ctrl-btn" id="prev-btn">&#9664;</button>
    <button class="ctrl-btn" id="next-btn">&#9654;</button>
  </div>
  <p id="status">Loading...</p>
</div>

<audio id="player"></audio>

<script>
var months = ['January','February','March','April','May','June',
  'July','August','September','October','November','December'];
document.getElementById('month-label').innerHTML =
  'Hits of ' + months[new Date().getMonth()];

var tracks = [];
var idx = 0;
var player = document.getElementById('player');
var artwork = document.getElementById('artwork');
var trackTitle = document.getElementById('track-title');
var status = document.getElementById('status');

function loadTracks() {
  var xhr = new XMLHttpRequest();
  xhr.open('GET', 'tracks.json?v=' + new Date().getTime(), true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        try {
          tracks = JSON.parse(xhr.responseText);
        } catch(e) {
          tracks = [];
        }
        if (tracks.length > 0) {
          status.innerHTML = 'Tap a button to begin';
          showTrack(0);
        } else {
          status.innerHTML = 'No tracks found';
        }
      } else {
        status.innerHTML = 'Could not load tracks (' + xhr.status + ')';
      }
    }
  };
  xhr.send();
}

function showTrack(i) {
  idx = ((i % tracks.length) + tracks.length) % tracks.length;
  var t = tracks[idx];
  trackTitle.innerHTML = t.title;
  if (t.image) {
    artwork.src = t.image;
    artwork.style.display = 'block';
  } else {
    artwork.style.display = 'none';
  }
  player.src = t.audio;
}

function playTrack(i) {
  showTrack(i);
  var playPromise = player.play();
  if (playPromise !== undefined) {
    playPromise.then(function() {
      status.innerHTML = '';
    }).catch(function() {
      status.innerHTML = 'Tap play to start';
    });
  }
}

player.addEventListener('ended', function() {
  playTrack(idx + 1);
});

document.getElementById('prev-btn').addEventListener('click', function() {
  if (player.currentTime > 3) {
    player.currentTime = 0;
  } else {
    playTrack(idx - 1);
  }
});

document.getElementById('next-btn').addEventListener('click', function() {
  playTrack(idx + 1);
});

loadTracks();
</script>
</body>
</html>
